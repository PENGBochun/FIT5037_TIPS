### Task 4: Secure Network Design and Implementation (Step-by-Step Guide)

**Final Objective**: Build a fully functional, encrypted three-campus network, and prepare both the video demonstration and report.

---

### **Part 1: Preparation**

#### **1.1 Project Loading and IP Planning**

1. **Load Project**: In GNS3, load the `Monash` project.
2. **IP Address Blueprint**: This table is the reference for all devices. All configurations later will follow this addressing scheme.

| Device                                       | New IP Address    | Netmask         | Gateway           |
| -------------------------------------------- | ----------------- | --------------- | ----------------- |
| **--- Caulfield LAN (`10.202.10.0/24`) ---** |                   |                 |                   |
| CAULFIELD-CLIENT-01                          | `10.202.10.10`    | `255.255.255.0` | `10.202.10.1`     |
| WEB Server                                   | `10.202.10.20`    | `255.255.255.0` | `10.202.10.1`     |
| SMTP Server                                  | `10.202.10.21`    | `255.255.255.0` | `10.202.10.1`     |
| SSH Server                                   | `10.202.10.22`    | `255.255.255.0` | `10.202.10.1`     |
| DNS Server                                   | `10.202.10.23`    | `255.255.255.0` | `10.202.10.1`     |
| CA Server                                    | `10.202.10.24`    | `255.255.255.0` | `10.202.10.1`     |
| **--- Clayton LAN (`10.200.10.0/24`) ---**   |                   |                 |                   |
| CLAYTON-CLIENT-01                            | `10.200.10.10`    | `255.255.255.0` | `10.200.10.1`     |
| **--- Peninsula LAN (`10.201.10.0/24`) ---** |                   |                 |                   |
| PENINSULA-CLIENT-01                          | `10.201.10.10`    | `255.255.255.0` | `10.201.10.1`     |
| **--- ISP Network (`192.168.122.0/24`) ---** |                   |                 |                   |
| External-Attacker                            | `192.168.122.100` | `255.255.255.0` | `192.168.122.202` |

#### **1.2 Topology Completion**

1. **Add Clients**: Drag Ubuntu containers to Clayton and Peninsula LANs, rename them appropriately.
2. **Add Servers**: Add 5 Ubuntu containers to **Caulfield** LAN, named `WEB`, `SMTP`, `SSH`, `DNS`, `CA`.

   * Requirement: WEB, SMTP, SSH are **external servers** and must be in the Primary DC (Caulfield). DNS and CA are internal, also placed at Caulfield.
3. **Add Attacker**: Add one Ubuntu container named `External-Attacker`, connect to ISP switch.

---

### **Part 2: Basic Node Configuration**

For each device, complete the following:

#### **A. Network Configuration** (`/etc/network/interfaces`)

Example for **WEB Server**:

```bash
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
    address 10.202.10.20
    netmask 255.255.255.0
    gateway 10.202.10.1
```

#### **B. Hostname Resolution** (`/etc/hosts`)

Example for **WEB Server**:

```bash
127.0.0.1       localhost
10.202.10.20    WEB
```

Repeat with correct IP/hostname for each server.

#### **C. Restart Network and Install Tools**

```bash
/etc/init.d/networking restart
apt-get update
apt-get install -y nano net-tools dnsutils curl openssh-client telnet
```

Ensure `/etc/resolv.conf` has a temporary DNS like `8.8.8.8` if updates fail.

---

### **Part 3: Service Installation and Verification**

#### **3.1 WEB Server (`10.202.10.20`)**

```bash
apt-get install -y apache2
echo "<html><body><h1>Student ID: magicnumber</h1></body></html>" > /var/www/html/index.html
service apache2 restart
curl http://10.202.10.20
```

#### **3.2 SSH Server (`10.202.10.22`)**

```bash
apt-get install -y openssh-server
nano /etc/ssh/sshd_config   # Set PermitRootLogin yes
passwd                      # Set root password
service ssh restart
ssh root@10.202.10.22
```

#### **3.3 SMTP Server (`10.202.10.21`)**

```bash
apt-get install -y postfix   # Choose Internet Site, domain = magicnumber.com
service postfix restart
telnet 10.202.10.21 25
```

#### **3.4 DNS Server (`10.202.10.23`)**

```bash
apt-get install -y dnsmasq
nano /etc/dnsmasq.conf
```

Add at end:

```bash
listen-address=10.202.10.23
bind-interfaces
domain-needed
bogus-priv
server=8.8.8.8
server=8.8.4.4
address=/magicnumber.com/10.202.10.20
address=/smtp.magicnumber.com/10.202.10.21
```

Then:

```bash
service dnsmasq restart
echo "nameserver 10.202.10.23" > /etc/resolv.conf
dig magicnumber.com
dig www.monash.edu
```

#### **3.5 CA Server (`10.202.10.24`)**

```bash
apt-get install -y openssl
mkdir /root/ca && cd /root/ca
openssl genrsa -out ca.key 2048
openssl req -new -x509 -key ca.key -days 365 -out ca.crt -subj "/CN=Monash-FIT5037-CA"
ls /root/ca   # Expect ca.key, ca.crt
```

---

### **Part 4: TLS Deployment**

#### **4.1 HTTPS for WEB Server**

On WEB:

```bash
openssl genrsa -out /etc/ssl/private/magicnumber.com.key 2048
openssl req -new -key /etc/ssl/private/magicnumber.com.key -out /tmp/web.csr -subj "/CN=magicnumber.com"
```

Copy CSR to CA, sign:

```bash
openssl x509 -req -in web.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out web.crt -days 365
```

Return certs to WEB:

```bash
nano /etc/ssl/certs/magicnumber.com.crt  # Paste web.crt
nano /etc/ssl/certs/ca.crt            # Paste ca.crt
nano /etc/apache2/sites-available/default-ssl.conf
# Update SSLCertificateFile and SSLCertificateKeyFile accordingly
a2enmod ssl
a2ensite default-ssl.conf
service apache2 restart
```

Verify:

```bash
curl -k https://10.202.10.20
```

#### **4.2 TLS for SMTP Server**

On SMTP:

```bash
openssl genrsa -out /etc/ssl/private/smtp.key 2048
openssl req -new -key /etc/ssl/private/smtp.key -out /tmp/smtp.csr -subj "/CN=smtp.magicnumber.com"
```

Copy CSR to CA, sign:

```bash
openssl x509 -req -in smtp.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out smtp.crt -days 365
```

Return cert to SMTP:

```bash
nano /etc/ssl/certs/smtp.crt   # Paste smtp.crt
nano /etc/postfix/main.cf
```

Append:

```bash
smtpd_tls_cert_file=/etc/ssl/certs/smtp.crt
smtpd_tls_key_file=/etc/ssl/private/smtp.key
smtpd_use_tls=yes
```

Restart and verify:

```bash
service postfix restart
openssl s_client -connect 10.202.10.21:25 -starttls smtp
```

Expect certificate chain and `250 DSN` welcome.

---