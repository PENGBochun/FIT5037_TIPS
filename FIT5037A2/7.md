### Task 7: Firewall

**Calculation**: `0`

* **Conclusion**:
  * **SSH Server**: Accessible **only from Caulfield campus clients** and **all external clients**.
  * **MAIL (SMTP) Server**: Accessible **only from Clayton campus clients**.

---

#### **Step 1: Clear Existing Rules (Execute on All Three Firewalls)**

To ensure a clean start, run the following command on `CAULFIELD-FW`, `CLAYTON-FW`, and `PENINSULA-FW` to remove all existing filter rules:

```bash
/ip firewall filter remove [find]
```

---

#### **Step 2: Apply Final Firewall Configuration**

After clearing the old rules, copy and paste the following configuration blocks into the respective firewalls. These rules integrate all previous troubleshooting fixes.

##### **A. CAULFIELD-FW Final Configuration**

```bash
/ip firewall address-list
add address=10.200.10.0/24 list=CampusLANs
add address=10.201.10.0/24 list=CampusLANs
add address=10.202.10.0/24 list=CampusLANs

/ip firewall filter
add action=accept chain=forward connection-state=established,related
add action=accept chain=forward ipsec-policy=in,ipsec
add action=drop chain=forward connection-state=invalid
add action=accept chain=input protocol=ipsec-esp
add action=accept chain=input protocol=udp dst-port=500,4500
add action=accept chain=output protocol=ipsec-esp
add action=accept chain=output protocol=udp dst-port=500,4500
add action=accept chain=input protocol=icmp src-address=10.202.10.0/24
add action=accept chain=output protocol=icmp
add action=accept chain=forward protocol=tcp dst-address=10.202.10.20 dst-port=80,443
add action=accept chain=forward protocol=tcp src-address-list=CampusLANs dst-address=10.202.10.23 dst-port=53
add action=accept chain=forward protocol=udp src-address-list=CampusLANs dst-address=10.202.10.23 dst-port=53
add action=accept chain=forward protocol=tcp src-address=10.202.10.0/24 dst-address=10.202.10.22 dst-port=22
add action=accept chain=forward protocol=tcp src-address=10.200.10.0/24 dst-address=10.202.10.21 dst-port=25,465,587
add action=accept chain=forward src-address=192.168.122.100 out-interface=ether1
add action=drop chain=input
add action=drop chain=output
add action=accept chain=forward dst-address=10.202.10.22 dst-port=22 in-interface=ether1 protocol=tcp src-address-list=!CampusLANs
add action=drop chain=forward
```

##### **B. CLAYTON-FW Final Configuration**

```bash
/ip firewall filter
add action=accept chain=forward connection-state=established,related
add action=accept chain=forward ipsec-policy=in,ipsec
add action=drop chain=forward connection-state=invalid
add action=accept chain=input protocol=ipsec-esp
add action=accept chain=input protocol=udp dst-port=500,4500
add action=accept chain=output protocol=ipsec-esp
add action=accept chain=output protocol=udp dst-port=500,4500
add action=accept chain=input protocol=icmp src-address=10.200.10.0/24
add action=accept chain=output protocol=icmp
add action=accept chain=forward src-address=10.200.10.0/24
add action=drop chain=input
add action=drop chain=output
add action=drop chain=forward
```

##### **C. PENINSULA-FW Final Configuration**

```bash
/ip firewall filter
add action=accept chain=forward connection-state=established,related
add action=accept chain=forward ipsec-policy=in,ipsec
add action=drop chain=forward connection-state=invalid
add action=accept chain=input protocol=ipsec-esp
add action=accept chain=input protocol=udp dst-port=500,4500
add action=accept chain=output protocol=ipsec-esp
add action=accept chain=output protocol=udp dst-port=500,4500
add action=accept chain=input protocol=icmp src-address=10.201.10.0/24
add action=accept chain=output protocol=icmp
add action=accept chain=forward src-address=10.201.10.0/24
add action=drop chain=input
add action=drop chain=output
add action=drop chain=forward
```

---

#### **Step 3: Verification Plan (For Video Demonstration)**

Use the following test cases to systematically validate your firewall configuration. In your video, clearly state the test objective and expected result before running each command.

| **Category**        | **Source Node**       | **Command**                      | **Expected Result**        | **Purpose**                   |
| ------------------- | --------------------- | -------------------------------- | -------------------------- | ----------------------------- |
| **General Rules**   |                       |                                  |                            |                               |
| WEB (Internal)      | `CLAYTON-CLIENT-01`   | `curl -k https://10.202.10.20`   | **Success**                | Allow internal access to WEB  |
| WEB (External)      | `External-Attacker`   | `curl -k https://10.202.10.20`   | **Success**                | Allow external access to WEB  |
| DNS (Internal)      | `PENINSULA-CLIENT-01` | `dig magicnumber.com @10.202.10.23` | **Success**                | Allow internal access to DNS  |
| DNS (External)      | `External-Attacker`   | `dig magicnumber.com @10.202.10.23` | **Fail (timeout)**         | Deny external access to DNS   |
| Ping Gateway        | `CLAYTON-CLIENT-01`   | `ping -c 4 10.200.10.1`          | **Success**                | Allow client ping to gateway  |
| **Specific Rules**  |                       |                                  |                            |                               |
| SMTP (Allowed)      | `CLAYTON-CLIENT-01`   | `telnet 10.202.10.21 25`         | **Success**                | Only Clayton can access SMTP  |
| SMTP (Denied)       | `PENINSULA-CLIENT-01` | `telnet 10.202.10.21 25`         | **Fail (timeout)**         | Deny non-Clayton SMTP access  |
| SSH (Allowed, LAN)  | `CAULFIELD-CLIENT-01` | `ssh root@10.202.10.22`          | **Success** (login prompt) | Allow Caulfield SSH access    |
| SSH (Allowed, WAN)  | `External-Attacker`   | `ssh root@10.202.10.22`          | **Success** (login prompt) | Allow external SSH access     |
| SSH (Denied)        | `PENINSULA-CLIENT-01` | `ssh root@10.202.10.22`          | **Fail (timeout)**         | Deny other campus SSH access  |
| **Topology Limits** |                       |                                  |                            |                               |
| SMTP (Bypass)       | `CAULFIELD-CLIENT-01` | `telnet 10.202.10.21 25`         | **Success**                | Demonstrates intra-LAN bypass |

---

#### **Step 4: Report Writing Guide**

According to the assessment requirements, you must provide firewall rule screenshots and fill in the rule template.

* **Capture Screenshots**: On **each firewall**, run the following command and take a screenshot of the output:

  ```bash
  /ip firewall filter print
  ```

* **Fill Template**: Use the output of the `print` or `export` command to accurately complete the firewall rule documentation table in your report.

---